<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000">
  <title>TaxiMap PWA</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlRheGlNYXAgUFdBIiwKICAic2hvcnRfbmFtZSI6ICJUYXhpTWFwIiwKICAiZGVzY3JpcHRpb24iOiAiQXBsaWNhY2nDs24gZGUgdGF4aSBjb24gR1BTIHkgem9uYXMgVU1hcCIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzAwMDAwMCIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDAwMDAiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1qUXdJaUJvWldsbmFIUTlJakl3TUNJZ2RtbGxkMEp2ZUQwaU1DQXdJREkwTUNBeU5EQWlJR1pwYkd3OUlpTXdNREF3TURBaUlIaHRiRzV6UFNKb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaVBnb2dJRHhqYVhKamJHVWdZM2c5SWpFeU1DSWdZM2s5SWpFeU1DSWdjajBpTXpBaUlHWnBiR3c5SWpFd1FqazRNU0l2UGdvZ0lEeDBaWGgwSUhnOUlqRXlNQ0lnZVQwaU1UUXdJaUJtYjI1MExYTnBlbVU5SWpNMklpQm1hV3hzUFNKM2FHbDBaU0lnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJK1BGOUROekE4TDNSbGVIUStDaUE4TDNOMlp6ND0iLAogICAgICAic2l6ZXMiOiAiMjQweDI0MCIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU5URXlJaUJvWldsbmFIUTlJalV4TWlJZ2RtbGxkMEp2ZUQwaU1DQXdJalV4TWlBMU1USWlJR1pwYkd3OUlpTXdNREF3TURBaUlIaHRiRzV6UFNKb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaVBnb2dJRHhqYVhKamJHVWdZM2c5SWpJMU5pSWdZM2s5SWpJMU5pSWdjajBpTmpRaUlHWnBiR3c5SWpFd1FqazRNU0l2UGdvZ0lEeDBaWGgwSUhnOUlqSTFOaUlnZVQwaU1qazJJaUJtYjI1MExYTnBlbVU5SWpjeU5pSWdabWxzYkQwaWQyaHBkR1VpSUhSbGVIUXRZVzVqYUc5eVBTSnRhV1JrYkdVaVBsUmhlR2xOU1dWeUNpQWdQQzkwWlhoMFBnb2dQQzl6ZG1jKyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDI0MCAyNDAiIGZpbGw9IiMwMDAwMDAiIHhtbG5zPSJodHRwOi8vL3d3dy53My5vcmcvMjAwMC9zdmciPgogIDxjaXJjbGUgY3g9IjEyMCIgY3k9IjEyMCIgcj0iMzAiIGZpbGw9IiMxMEI5ODEiLz4KICA8dGV4dCB4PSIxMjAiIHk9IjE0MCIgZm9udC1zaXplPSIzNiIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPjxfQ0Y8L3RleHQ+CiA8L3N2Zz4=">
  
  <!-- Meta tags para PWA -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="TaxiMap">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Leaflet CSS/JS desde CDN alternativo -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #1f2937;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    .taxi-marker {
      border: none !important;
      background: transparent !important;
    }

    .leaflet-container {
      background: #f0f0f0 !important;
    }
  </style>
</head>
<body>
  <div id="root">
    <div class="h-screen bg-gray-900 text-white flex flex-col">
      <!-- Header -->
      <div class="bg-black p-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <div id="gps-indicator" class="w-3 h-3 rounded-full bg-green-400 animate-pulse"></div>
          <span class="text-sm font-medium" id="gps-status">GPS SIM ON</span>
        </div>
        <div class="text-center">
          <h1 class="text-lg font-bold">TaxiMap</h1>
        </div>
        <div class="flex space-x-2">
          <button onclick="loadUMapFile()" class="p-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-all active:scale-95" title="Cargar archivo UMap">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
          </button>
          <button onclick="toggleGPS()" id="gps-toggle" class="p-2 rounded-lg transition-all active:scale-95 bg-gray-700 text-gray-400 hover:bg-gray-600" title="Cambiar a GPS real">
            üéØ
          </button>
        </div>
      </div>

      <!-- Input oculto para archivos -->
      <input id="fileInput" type="file" accept=".umap,.json" onchange="handleFileLoad(event)" style="display: none;">

      <!-- Zona actual -->
      <div class="bg-gray-800 px-4 py-2 flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          <span class="font-medium" id="current-zone">Zona: Fuera de zona</span>
        </div>
        <div class="text-xs text-gray-400" id="coordinates">
          28.4636, -16.2518
        </div>
      </div>

      <!-- Instrucciones -->
      <div class="bg-gray-700 text-white px-4 py-2 text-sm">
        <div class="flex items-center justify-between">
          <span id="instructions">üì± GPS SIMULADO - movimiento autom√°tico | ‚¨ÜÔ∏è Carga .umap</span>
          <span class="text-xs opacity-75">Zonas: <span id="zone-count">0</span></span>
        </div>
      </div>

      <!-- Mapa -->
      <div class="flex-1 relative">
        <div id="map" class="w-full h-full" style="background: #f0f0f0;"></div>

        <!-- Controles de zoom -->
        <div class="absolute right-4 top-4 flex flex-col space-y-2 z-10">
          <button onclick="zoomIn()" class="w-10 h-10 bg-black bg-opacity-70 rounded-lg flex items-center justify-center text-white text-xl font-bold hover:bg-opacity-90 transition-all active:scale-95">
            +
          </button>
          <button onclick="zoomOut()" class="w-10 h-10 bg-black bg-opacity-70 rounded-lg flex items-center justify-center text-white text-xl font-bold hover:bg-opacity-90 transition-all active:scale-95">
            ‚àí
          </button>
          <button onclick="centerMap()" class="w-10 h-10 bg-black bg-opacity-70 rounded-lg flex items-center justify-center text-white hover:bg-opacity-90 transition-all active:scale-95">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
          </button>
        </div>
      </div>

      <!-- Panel inferior -->
      <div class="bg-black p-6 space-y-4">
        <div class="flex space-x-4">
          <button onclick="toggleStatus()" id="status-btn" class="flex-1 py-4 px-6 rounded-xl font-bold text-lg transition-all duration-300 active:scale-95 bg-green-500 hover:bg-green-600 text-white shadow-lg shadow-green-500/30">
            üü¢ LIBRE
          </button>
          
          <button class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-xl transition-all active:scale-95">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
          </button>
        </div>

        <div class="flex justify-between text-sm text-gray-400">
          <span>Tiempo en zona: 12 min</span>
          <span>Servicios hoy: 8</span>
          <span class="flex items-center space-x-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            <span>85%</span>
          </span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables globales
    let map;
    let userMarker;
    let zoneShapes = [];
    let zones = {};
    let currentZone = 'Fuera de zona';
    let taxiLocation = { lat: 28.4636, lng: -16.2518 };
    let status = 'free';
    let useRealGPS = false;
    let gpsEnabled = true;
    let watchId;
    let simulationInterval;

    const zoneColors = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];

    // Inicializar mapa
    function initMap() {
      console.log('Initializing map...');
      
      map = L.map('map', {
        zoomControl: false,
        attributionControl: false
      }).setView([taxiLocation.lat, taxiLocation.lng], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // Crear marcador del taxi
      createTaxiMarker();
      
      console.log('Map initialized successfully');
      
      // Iniciar simulaci√≥n GPS
      startGPSSimulation();
    }

    // Crear marcador del taxi
    function createTaxiMarker() {
      const color = status === 'free' ? '#10B981' : '#EF4444';
      
      const taxiIcon = L.divIcon({
        className: 'taxi-marker',
        html: `<div style="
          width: 30px; 
          height: 30px; 
          background: ${color}; 
          border: 3px solid white; 
          border-radius: 50%; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          box-shadow: 0 2px 10px rgba(0,0,0,0.3);
          font-size: 16px;
        ">üöï</div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });

      if (userMarker) {
        map.removeLayer(userMarker);
      }

      userMarker = L.marker([taxiLocation.lat, taxiLocation.lng], { icon: taxiIcon }).addTo(map);
    }

    // Iniciar simulaci√≥n GPS
    function startGPSSimulation() {
      if (simulationInterval) clearInterval(simulationInterval);
      
      simulationInterval = setInterval(() => {
        if (!useRealGPS) {
          const newLat = taxiLocation.lat + (Math.random() - 0.5) * 0.0005;
          const newLng = taxiLocation.lng + (Math.random() - 0.5) * 0.0005;
          
          taxiLocation = { lat: newLat, lng: newLng };
          updateTaxiPosition(newLat, newLng);
        }
      }, 2000);
    }

    // Iniciar GPS real
    function startRealGPS() {
      if (!navigator.geolocation) {
        alert('GPS no soportado en este dispositivo\nUsando modo simulado...');
        useRealGPS = false;
        updateGPSStatus();
        return;
      }

      const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 1000
      };

      const onSuccess = (position) => {
        const newLat = position.coords.latitude;
        const newLng = position.coords.longitude;
        
        taxiLocation = { lat: newLat, lng: newLng };
        updateTaxiPosition(newLat, newLng);
        gpsEnabled = true;
        updateGPSStatus();
      };

      const onError = (error) => {
        console.error('GPS Error:', error);
        alert('Error GPS: ' + error.message + '\nCambiando a modo simulado...');
        useRealGPS = false;
        gpsEnabled = false;
        updateGPSStatus();
        startGPSSimulation();
      };

      navigator.geolocation.getCurrentPosition(onSuccess, onError, options);
      watchId = navigator.geolocation.watchPosition(onSuccess, onError, options);
    }

    // Actualizar posici√≥n del taxi
    function updateTaxiPosition(newLat, newLng) {
      if (userMarker) {
        userMarker.setLatLng([newLat, newLng]);
        
        // Actualizar coordenadas en UI
        document.getElementById('coordinates').textContent = `${newLat.toFixed(4)}, ${newLng.toFixed(4)}`;
        
        // Detectar zonas
        detectZone(newLat, newLng);
      }
    }

    // Detectar zona
    function detectZone(lat, lng) {
      let detectedZone = 'Fuera de zona';
      let previousZone = currentZone;

      Object.entries(zones).forEach(([name, data]) => {
        if (data.type === 'polygon' && isPointInPolygon(lat, lng, data.coordinates)) {
          detectedZone = name;
        } else if (data.type === 'circle' && getDistance(lat, lng, data.lat, data.lng) < data.radius) {
          detectedZone = name;
        }
      });

      if (detectedZone !== 'Fuera de zona' && detectedZone !== previousZone) {
        showZoneNotification(detectedZone);
      }

      currentZone = detectedZone;
      document.getElementById('current-zone').textContent = `Zona: ${currentZone}`;
    }

    // Mostrar notificaci√≥n de zona
    function showZoneNotification(zoneName) {
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
      }
      
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: #10B981;
        color: white;
        padding: 10px 20px;
        border-radius: 10px;
        z-index: 10000;
        font-weight: bold;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      `;
      notification.textContent = `¬°Zona: ${zoneName}!`;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (document.body.contains(notification)) {
          document.body.removeChild(notification);
        }
      }, 3000);
    }

    // Verificar punto en pol√≠gono
    function isPointInPolygon(lat, lng, polygonCoords) {
      let inside = false;
      const x = lat;
      const y = lng;
      
      for (let i = 0, j = polygonCoords.length - 1; i < polygonCoords.length; j = i++) {
        const xi = polygonCoords[i][0];
        const yi = polygonCoords[i][1];
        const xj = polygonCoords[j][0];
        const yj = polygonCoords[j][1];
        
        if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
          inside = !inside;
        }
      }
      
      return inside;
    }

    // Calcular distancia
    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI/180;
      const œÜ2 = lat2 * Math.PI/180;
      const ŒîœÜ = (lat2-lat1) * Math.PI/180;
      const ŒîŒª = (lng2-lng1) * Math.PI/180;

      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c;
    }

    // Funciones de control
    function toggleStatus() {
      status = status === 'free' ? 'busy' : 'free';
      const btn = document.getElementById('status-btn');
      
      if (status === 'free') {
        btn.className = 'flex-1 py-4 px-6 rounded-xl font-bold text-lg transition-all duration-300 active:scale-95 bg-green-500 hover:bg-green-600 text-white shadow-lg shadow-green-500/30';
        btn.innerHTML = 'üü¢ LIBRE';
      } else {
        btn.className = 'flex-1 py-4 px-6 rounded-xl font-bold text-lg transition-all duration-300 active:scale-95 bg-red-500 hover:bg-red-600 text-white shadow-lg shadow-red-500/30';
        btn.innerHTML = 'üî¥ OCUPADO';
      }
      
      createTaxiMarker();
      
      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
    }

    function toggleGPS() {
      useRealGPS = !useRealGPS;
      
      if (useRealGPS) {
        if (simulationInterval) clearInterval(simulationInterval);
        startRealGPS();
      } else {
        if (watchId) navigator.geolocation.clearWatch(watchId);
        startGPSSimulation();
      }
      
      updateGPSStatus();
      
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    function updateGPSStatus() {
      const indicator = document.getElementById('gps-indicator');
      const status = document.getElementById('gps-status');
      const toggle = document.getElementById('gps-toggle');
      const instructions = document.getElementById('instructions');
      
      if (useRealGPS && gpsEnabled) {
        indicator.className = 'w-3 h-3 rounded-full bg-green-400 animate-pulse';
        status.textContent = 'GPS REAL ON';
        toggle.className = 'p-2 rounded-lg transition-all active:scale-95 bg-green-600 text-white';
        toggle.textContent = 'üì°';
        instructions.textContent = 'üì± GPS REAL activo - tu ubicaci√≥n actual | ‚¨ÜÔ∏è Carga .umap';
      } else if (useRealGPS && !gpsEnabled) {
        indicator.className = 'w-3 h-3 rounded-full bg-red-400';
        status.textContent = 'GPS REAL OFF';
        toggle.className = 'p-2 rounded-lg transition-all active:scale-95 bg-red-600 text-white';
        toggle.textContent = 'üì°';
        instructions.textContent = 'üì± GPS REAL error - usando simulado | ‚¨ÜÔ∏è Carga .umap';
      } else {
        indicator.className = 'w-3 h-3 rounded-full bg-green-400 animate-pulse';
        status.textContent = 'GPS SIM ON';
        toggle.className = 'p-2 rounded-lg transition-all active:scale-95 bg-gray-700 text-gray-400 hover:bg-gray-600';
        toggle.textContent = 'üéØ';
        instructions.textContent = 'üì± GPS SIMULADO - movimiento autom√°tico | ‚¨ÜÔ∏è Carga .umap';
      }
    }

    function zoomIn() {
      if (map) map.zoomIn();
    }

    function zoomOut() {
      if (map) map.zoomOut();
    }

    function centerMap() {
      if (map) map.setView([taxiLocation.lat, taxiLocation.lng], 15);
    }

    function loadUMapFile() {
      document.getElementById('fileInput').click();
    }

    function handleFileLoad(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const umapData = JSON.parse(e.target.result);
          parseUMapData(umapData);
        } catch (error) {
          alert('Error al leer el archivo UMap');
        }
      };
      reader.readAsText(file);
    }

    function parseUMapData(umapData) {
      zones = {};
      let colorIndex = 0;

      const findFeatures = (obj) => {
        if (!obj || typeof obj !== 'object') return;
        
        if (obj.features && Array.isArray(obj.features)) {
          obj.features.forEach((feature) => {
            const name = feature.properties?.name || 
                        feature.properties?.title || 
                        feature.properties?.description || 
                        `Zona ${colorIndex + 1}`;
            
            if (!name) return;

            if (feature.geometry?.type === 'Polygon') {
              let coordinates = feature.geometry.coordinates[0] || feature.geometry.coordinates;
              if (!coordinates || coordinates.length === 0) return;

              const leafletCoords = coordinates.map(coord => [coord[1], coord[0]]);
              
              zones[name] = {
                type: 'polygon',
                coordinates: leafletCoords,
                color: zoneColors[colorIndex % zoneColors.length]
              };
              
              colorIndex++;
            }
          });
        }
        
        for (const key in obj) {
          if (obj.hasOwnProperty(key) && typeof obj[key] === 'object') {
            findFeatures(obj[key]);
          }
        }
      };

      findFeatures(umapData);
      updateMapZones();
      
      document.getElementById('zone-count').textContent = Object.keys(zones).length;
      
      if (Object.keys(zones).length > 0) {
        // Centrar en la primera zona
        const firstZone = Object.values(zones)[0];
        if (firstZone.type === 'polygon' && firstZone.coordinates.length > 0) {
          const centerLat = firstZone.coordinates.reduce((sum, coord) => sum + coord[0], 0) / firstZone.coordinates.length;
          const centerLng = firstZone.coordinates.reduce((sum, coord) => sum + coord[1], 0) / firstZone.coordinates.length;
          map.setView([centerLat, centerLng], 15);
        }
      }
    }

    function updateMapZones() {
      if (!map) return;

      // Limpiar zonas existentes
      zoneShapes.forEach(shape => {
        map.removeLayer(shape);
      });
      zoneShapes = [];

      // A√±adir nuevas zonas
      Object.entries(zones).forEach(([zoneName, zoneData]) => {
        let shape;
        
        if (zoneData.type === 'polygon') {
          shape = L.polygon(zoneData.coordinates, {
            color: zoneData.color,
            fillColor: zoneData.color,
            fillOpacity: 0.3,
            weight: 3
          });
        } else if (zoneData.type === 'circle') {
          shape = L.circle([zoneData.lat, zoneData.lng], {
            color: zoneData.color,
            fillColor: zoneData.color,
            fillOpacity: 0.2,
            weight: 2,
            radius: zoneData.radius
          });
        }
        
        if (shape) {
          shape.addTo(map);
          shape.bindPopup(`<b>${zoneName}</b><br>Tipo: ${zoneData.type}`);
          zoneShapes.push(shape);
        }
      });
    }

    // Service Worker para PWA (simplificado)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Service Worker b√°sico sin cache complejo
        const swCode = `
          self.addEventListener('fetch', (event) => {
            // Solo intercepta, no hace cache para evitar errores
            event.respondWith(fetch(event.request));
          });
        `;

        try {
          const blob = new Blob([swCode], { type: 'application/javascript' });
          const swUrl = URL.createObjectURL(blob);
          
          navigator.serviceWorker.register(swUrl)
            .then(() => console.log('SW registered'))
            .catch(() => console.log('SW failed - but app still works'));
        } catch (e) {
          console.log('SW not supported - but app still works');
        }
      });
    }

    // Install prompt para PWA
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      setTimeout(() => {
        const installButton = document.createElement('div');
        installButton.style.cssText = `
          position: fixed;
          bottom: 100px;
          right: 20px;
          background: #10B981;
          color: white;
          padding: 12px 20px;
          border-radius: 25px;
          cursor: pointer;
          font-weight: bold;
          box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
          z-index: 10000;
          animation: pulse 2s infinite;
        `;
        installButton.innerHTML = 'üì± Instalar App';
        installButton.onclick = () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
              deferredPrompt = null;
              document.body.removeChild(installButton);
            });
          }
        };
        document.body.appendChild(installButton);
        
        setTimeout(() => {
          if (document.body.contains(installButton)) {
            document.body.removeChild(installButton);
          }
        }, 10000);
      }, 3000);
    });

    // Variables de control
    let mapInitialized = false;

    // Inicializar cuando se carga la p√°gina
    let maxRetries = 50; // 10 segundos m√°ximo
    let retryCount = 0;

    function waitForLeaflet() {
      if (mapInitialized) {
        console.log('Map already initialized, skipping...');
        return;
      }

      if (typeof L !== 'undefined') {
        console.log('Leaflet found, initializing map...');
        mapInitialized = true;
        initMap();
      } else if (retryCount < maxRetries) {
        console.log(`Waiting for Leaflet... (${retryCount}/${maxRetries})`);
        retryCount++;
        setTimeout(waitForLeaflet, 200);
      } else {
        console.error('Leaflet failed to load after 10 seconds');
        showErrorMessage('Error: No se pudo cargar el mapa. Verifica tu conexi√≥n a internet.');
      }
    }

    function showErrorMessage(message) {
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #EF4444;
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        z-index: 10000;
        max-width: 300px;
      `;
      errorDiv.innerHTML = `
        <h3>Problema de conexi√≥n</h3>
        <p>${message}</p>
        <button onclick="location.reload()" style="
          background: white;
          color: #EF4444;
          border: none;
          padding: 10px 20px;
          border-radius: 5px;
          margin-top: 10px;
          cursor: pointer;
        ">Recargar p√°gina</button>
      `;
      document.body.appendChild(errorDiv);
    }

    window.addEventListener('load', () => {
      console.log('Page loaded, waiting for Leaflet...');
      waitForLeaflet();
    });
  </script>

  <style>
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
  </style>
</body>
</html>
