
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#000000"/>
  <title>TaxiMap PWA</title>

  <!-- PWA Manifest (mantengo el base64 que ten√≠as) -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlRheGlNYXAgUFdBIiwKICAic2hvcnRfbmFtZSI6ICJUYXhpTWFwIiwKICAiZGVzY3JpcHRpb24iOiAiQXBsaWNhY2nDs24gZGUgdGF4aSBjb24gR1BTIHkgem9uYXMgVU1hcCIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzAwMDAwMCIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDAwMDAiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1qUXdJaUJvWldsbmFIUTlJakl3TUNJZ2RtbGxkMEp2ZUQwaU1DQXdJREkwTUNBeU5EQWlJR1pwYkd3OUlpTXdNREF3TURBaUlIaHRiRzV6UFNKb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaVBnb2dJRHhqYVhKamJHVWdZM2c5SWpFeU1DSWdZM2s5SWpFeU1DSWdjajBpTXpBaUlHWnBiR3c5SWpFd1FqazRNU0l2UGdvZ0lEeDBaWGgwSUhnOUlqRXlNQ0lnZVQwaU1UUXdJaUJtYjI1MExYTnBlbVU5SWpNMklpQm1hV3hzUFNKM2FHbDBaU0lnZEdWNGRDMWhibU5vYjNJOUltMXBaR1JzWlNJK1BGOUROekE4TDNSbGVIUStDaUE4TDNOMlp6ND0iLAogICAgICAic2l6ZXMiOiAiMjQweDI0MCIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">

  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
  <meta name="apple-mobile-web-app-title" content="TaxiMap"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

  <style>
    body { margin:0; padding:0; background:#1f2937; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent; }
    .taxi-marker { border: none !important; background: transparent !important; }
    .leaflet-container { background: #f0f0f0 !important; }
    .my-location-pulse { animation: locationPulse 1.6s infinite; }
    @keyframes locationPulse { 0%{ transform:scale(1); opacity:1 } 50%{ transform:scale(1.3); opacity:0.6 } 100%{ transform:scale(1); opacity:1 } }
    @keyframes slideDown { from { transform: translateX(-50%) translateY(-12px); opacity:0 } to { transform: translateX(-50%) translateY(0); opacity:1 } }
  </style>
</head>
<body>
  <div id="root">
    <div class="h-screen bg-gray-900 text-white flex flex-col">
      <!-- Header -->
      <div class="bg-black p-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <div id="gps-indicator" class="w-3 h-3 rounded-full bg-green-400 animate-pulse"></div>
          <span class="text-sm font-medium" id="gps-status">GPS SIM ON</span>
        </div>
        <div class="text-center">
          <h1 class="text-lg font-bold">TaxiMap</h1>
        </div>
        <div class="flex space-x-2">
          <button onclick="loadUMapFile()" class="p-2 rounded-lg bg-blue-600 hover:bg-blue-700 transition-all active:scale-95" title="Cargar archivo UMap">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
          </button>
          <button onclick="toggleGPS()" id="gps-toggle" class="p-2 rounded-lg transition-all active:scale-95 bg-gray-700 text-gray-400 hover:bg-gray-600" title="Cambiar GPS">
            üéØ
          </button>
          <button onclick="toggleSpeech()" id="speech-toggle" class="p-2 rounded-lg transition-all active:scale-95 bg-green-600 hover:bg-green-700" title="Voz ON">
            üîä
          </button>
        </div>
      </div>

      <input id="fileInput" type="file" accept=".umap,.json" onchange="handleFileLoad(event)" style="display:none;">

      <!-- Zona y calle actual -->
      <div class="bg-gray-800 px-4 py-2">
        <div class="flex items-center justify-between mb-1">
          <div class="flex items-center space-x-2">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            <span class="font-medium" id="current-zone">Zona: Fuera de zona</span>
          </div>
          <div class="text-xs text-gray-400" id="coordinates">28.4636, -16.2518</div>
        </div>
        <div class="flex items-center space-x-2">
          <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m0 0L9 7"></path></svg>
          <span class="text-sm text-gray-300" id="current-street">Obteniendo calle...</span>
        </div>
      </div>

      <!-- Instrucciones -->
      <div class="bg-gray-700 text-white px-4 py-2 text-sm">
        <div class="flex items-center justify-between">
          <span id="instructions">üì± GPS SIMULADO | ‚¨ÜÔ∏è Carga .umap | üîä Voz ON</span>
          <span class="text-xs opacity-75">Zonas: <span id="zone-count">0</span></span>
        </div>
      </div>

      <!-- Mapa -->
      <div class="flex-1 relative">
        <div id="map" class="w-full h-full" style="background:#f0f0f0;"></div>

        <!-- Controles del mapa -->
        <div class="absolute right-4 top-4 flex flex-col space-y-2 z-10">
          <button onclick="zoomIn()" class="w-12 h-12 bg-black bg-opacity-70 rounded-lg flex items-center justify-center text-white text-xl font-bold hover:bg-opacity-90 transition-all active:scale-95">+</button>
          <button onclick="zoomOut()" class="w-12 h-12 bg-black bg-opacity-70 rounded-lg flex items-center justify-center text-white text-xl font-bold hover:bg-opacity-90 transition-all active:scale-95">‚àí</button>
          <button onclick="centerOnTaxi()" class="w-12 h-12 bg-black bg-opacity-70 rounded-lg flex items-center justify-center text-white hover:bg-opacity-90 transition-all active:scale-95" title="Centrar en taxi">üöï</button>
          <!-- pasamos event para poder estilizar el bot√≥n temporalmente -->
          <button onclick="centerOnMyLocation(event)" class="w-12 h-12 bg-blue-600 bg-opacity-80 rounded-lg flex items-center justify-center text-white hover:bg-opacity-100 transition-all active:scale-95" title="Mi ubicaci√≥n GPS">üìç</button>
        </div>
      </div>

      <!-- Panel inferior -->
      <div class="bg-black p-6 space-y-4">
        <div class="flex space-x-4">
          <button onclick="toggleStatus()" id="status-btn" class="flex-1 py-4 px-6 rounded-xl font-bold text-lg transition-all duration-300 active:scale-95 bg-green-500 hover:bg-green-600 text-white shadow-lg shadow-green-500/30">üü¢ LIBRE</button>

          <button class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-xl transition-all active:scale-95">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
          </button>
        </div>

        <div class="flex justify-between text-sm text-gray-400">
          <span>En zona: <span id="zone-timer">0 min</span></span>
          <span>Servicios: 8</span>
          <span>Bater√≠a: 85%</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Variables globales ---
    let map;
    let userMarker;
    let myLocationMarker;
    let zoneShapes = [];
    let zones = {}; // { name: { type: 'polygon'|'circle', coordinates: [[lat,lng],..] or lat,lng, radius }, ... }
    let currentZone = 'Fuera de zona';
    let taxiLocation = { lat: 28.4636, lng: -16.2518 };
    let status = 'free';
    let useRealGPS = false;
    let gpsEnabled = true;
    let speechEnabled = true;
    let watchId = null;
    let simulationInterval = null;
    let currentStreet = 'Obteniendo calle...';
    let mapInitialized = false;
    let zoneStartTime = null;
    let lastReverseTimestamp = 0;
    const REVERSE_INTERVAL = 10000; // ms, no m√°s de 1 petici√≥n cada 10s
    const zoneColors = ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#14B8A6', '#F97316'];

    // --- Helper voz ---
    function speak(text, opts = {}) {
      if (!speechEnabled || !('speechSynthesis' in window)) return;
      try {
        speechSynthesis.cancel();
      } catch(e){}
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'es-ES';
      utterance.volume = opts.volume ?? 0.9;
      utterance.rate = opts.rate ?? 1.0;
      speechSynthesis.speak(utterance);
    }

    // --- Inicializar mapa ---
    function initMap() {
      if (mapInitialized) return;
      map = L.map('map', { zoomControl:false, attributionControl:false }).setView([taxiLocation.lat, taxiLocation.lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution: '¬© OpenStreetMap contributors' }).addTo(map);

      createTaxiMarker();
      startGPSSimulation();

      // temporizador zona cada 1s
      setInterval(updateZoneTimer, 1000);

      mapInitialized = true;
      console.log('Map initialized');
    }

    // --- Marcador taxi ---
    function createTaxiMarker() {
      const color = status === 'free' ? '#10B981' : '#EF4444';
      const taxiIcon = L.divIcon({
        className: 'taxi-marker',
        html: `<div style="
          width:30px; height:30px; background:${color}; border:3px solid white; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 10px rgba(0,0,0,0.3); font-size:16px;
        ">üöï</div>`,
        iconSize: [30,30],
        iconAnchor: [15,15]
      });
      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([taxiLocation.lat, taxiLocation.lng], { icon: taxiIcon }).addTo(map);
    }

    // --- Simulaci√≥n GPS ---
    function startGPSSimulation() {
      if (simulationInterval) clearInterval(simulationInterval);
      simulationInterval = setInterval(() => {
        if (!useRealGPS) {
          const newLat = taxiLocation.lat + (Math.random() - 0.5) * 0.001;
          const newLng = taxiLocation.lng + (Math.random() - 0.5) * 0.001;
          taxiLocation = { lat: newLat, lng: newLng };
          updateTaxiPosition(newLat, newLng);
        }
      }, 3000);
    }

    // --- GPS real ---
    function startRealGPS() {
      if (!navigator.geolocation) {
        alert('GPS no soportado');
        useRealGPS = false;
        updateGPSStatus();
        return;
      }

      const options = { enableHighAccuracy:true, timeout:10000, maximumAge:2000 };

      const onSuccess = (position) => {
        const newLat = position.coords.latitude;
        const newLng = position.coords.longitude;
        taxiLocation = { lat: newLat, lng: newLng };
        updateTaxiPosition(newLat, newLng);
        gpsEnabled = true;
        updateGPSStatus();
      };

      const onError = (error) => {
        console.error('GPS Error:', error);
        gpsEnabled = false;
        useRealGPS = false;
        updateGPSStatus();
        startGPSSimulation();
      };

      // primera lectura y luego watch
      navigator.geolocation.getCurrentPosition(onSuccess, onError, options);
      if (watchId) navigator.geolocation.clearWatch(watchId);
      watchId = navigator.geolocation.watchPosition(onSuccess, onError, options);
    }

    // --- Actualizar posici√≥n taxi ---
    function updateTaxiPosition(newLat, newLng) {
      if (!userMarker) {
        createTaxiMarker();
      } else {
        userMarker.setLatLng([newLat, newLng]);
      }

      document.getElementById('coordinates').textContent = `${newLat.toFixed(6)}, ${newLng.toFixed(6)}`;

      // Geocodificaci√≥n inversa inteligente: no m√°s de REVERSE_INTERVAL
      const now = Date.now();
      if (now - lastReverseTimestamp > REVERSE_INTERVAL) {
        lastReverseTimestamp = now;
        getStreetName(newLat, newLng);
      }

      detectZone(newLat, newLng);
    }

    // --- Geocodificaci√≥n inversa (OpenStreetMap Nominatim) ---
    function getStreetName(lat, lng) {
      // protecci√≥n simple por si la API falla
      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
        .then(res => res.json())
        .then(data => {
          let streetName = 'Ubicaci√≥n desconocida';
          if (data && data.address) {
            streetName = data.address.road ||
                         data.address.pedestrian ||
                         data.address.cycleway ||
                         data.address.path ||
                         data.address.footway ||
                         data.display_name?.split(',')[0] ||
                         'Sin nombre';
          } else if (data && data.display_name) {
            streetName = data.display_name.split(',')[0];
          }
          currentStreet = streetName;
          document.getElementById('current-street').textContent = streetName;
        })
        .catch(err => {
          console.warn('Reverse geocode error', err);
          document.getElementById('current-street').textContent = 'Error obteniendo calle';
        });
    }

    // --- Detecci√≥n zonas ---
    function detectZone(lat, lng) {
      let detectedZone = 'Fuera de zona';
      const previousZone = currentZone;

      Object.entries(zones).forEach(([name, data]) => {
        if (data.type === 'polygon') {
          if (isPointInPolygon(lat, lng, data.coordinates)) {
            detectedZone = name;
          }
        } else if (data.type === 'circle') {
          const dist = getDistance(lat, lng, data.lat, data.lng); // metros
          if (dist <= data.radius) detectedZone = name;
        }
      });

      if (detectedZone !== previousZone) {
        if (detectedZone !== 'Fuera de zona') {
          showZoneNotification(detectedZone);
          zoneStartTime = Date.now();
        } else {
          zoneStartTime = null;
        }
        currentZone = detectedZone;
        document.getElementById('current-zone').textContent = `Zona: ${currentZone}`;
      }
    }

    // --- Temporizador zona (cada segundo por setInterval) ---
    function updateZoneTimer() {
      if (zoneStartTime && currentZone !== 'Fuera de zona') {
        const minutes = Math.floor((Date.now() - zoneStartTime) / 60000);
        const seconds = Math.floor(((Date.now() - zoneStartTime) % 60000) / 1000);
        document.getElementById('zone-timer').textContent = `${minutes}m ${seconds}s`;
      } else {
        document.getElementById('zone-timer').textContent = '0 min';
      }
    }

    // --- Notificaci√≥n de zona ---
    function showZoneNotification(zoneName) {
      if (navigator.vibrate) navigator.vibrate([200,100,200]);

      if (speechEnabled) speak(`Entrando en zona ${zoneName}`, { volume: 0.85 });

      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: #10B981;
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        z-index: 10000;
        font-weight: bold;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        animation: slideDown 0.3s ease-out;
      `;
      notification.textContent = `üéØ Zona: ${zoneName}`;
      document.body.appendChild(notification);
      setTimeout(()=>{ if (document.body.contains(notification)) document.body.removeChild(notification); }, 4000);
    }

    // --- Punto en pol√≠gono (ray-casting). polygonCoords = [[lat,lng],...] ---
    function isPointInPolygon(lat, lng, polygonCoords) {
      let inside = false;
      for (let i = 0, j = polygonCoords.length - 1; i < polygonCoords.length; j = i++) {
        const xi = polygonCoords[i][0], yi = polygonCoords[i][1];
        const xj = polygonCoords[j][0], yj = polygonCoords[j][1];

        const intersect = ((yi > lng) !== (yj > lng)) && (lat < (xj - xi) * (lng - yi) / (yj - yi) + xi);
        if (intersect) inside = !inside;
      }
      return inside;
    }

    // --- Distancia entre dos puntos (metros) ---
    function getDistance(lat1, lng1, lat2, lng2) {
      const R = 6371e3;
      const œÜ1 = lat1 * Math.PI/180;
      const œÜ2 = lat2 * Math.PI/180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI/180;
      const ŒîŒª = (lng2 - lng1) * Math.PI/180;
      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // --- Controles b√°sicos ---
    function toggleStatus() {
      status = status === 'free' ? 'busy' : 'free';
      const btn = document.getElementById('status-btn');
      if (status === 'free') {
        btn.className = 'flex-1 py-4 px-6 rounded-xl font-bold text-lg transition-all duration-300 active:scale-95 bg-green-500 hover:bg-green-600 text-white shadow-lg shadow-green-500/30';
        btn.innerHTML = 'üü¢ LIBRE';
      } else {
        btn.className = 'flex-1 py-4 px-6 rounded-xl font-bold text-lg transition-all duration-300 active:scale-95 bg-red-500 hover:bg-red-600 text-white shadow-lg shadow-red-500/30';
        btn.innerHTML = 'üî¥ OCUPADO';
      }
      createTaxiMarker();
      if (navigator.vibrate) navigator.vibrate(100);
    }

    function toggleGPS() {
      useRealGPS = !useRealGPS;
      if (useRealGPS) {
        if (simulationInterval) clearInterval(simulationInterval);
        startRealGPS();
      } else {
        if (watchId) navigator.geolocation.clearWatch(watchId);
        startGPSSimulation();
      }
      updateGPSStatus();
      if (navigator.vibrate) navigator.vibrate(50);
    }

    function toggleSpeech() {
      speechEnabled = !speechEnabled;
      const btn = document.getElementById('speech-toggle');
      if (speechEnabled) {
        btn.textContent = 'üîä';
        btn.title = 'Voz ON';
        btn.className = 'p-2 rounded-lg transition-all active:scale-95 bg-green-600 hover:bg-green-700';
        speak('Voz activada', { volume: 0.9 });
      } else {
        // cancel any speaking
        try { speechSynthesis.cancel(); } catch(e){}
        btn.textContent = 'üîá';
        btn.title = 'Voz OFF';
        btn.className = 'p-2 rounded-lg transition-all active:scale-95 bg-gray-600 hover:bg-gray-700';
      }
      updateInstructions();
      if (navigator.vibrate) navigator.vibrate(50);
    }

    function updateGPSStatus() {
      const indicator = document.getElementById('gps-indicator');
      const statusEl = document.getElementById('gps-status');
      const toggle = document.getElementById('gps-toggle');

      if (useRealGPS && gpsEnabled) {
        indicator.className = 'w-3 h-3 rounded-full bg-green-400 animate-pulse';
        statusEl.textContent = 'GPS REAL ON';
        toggle.className = 'p-2 rounded-lg transition-all active:scale-95 bg-green-600 text-white';
        toggle.textContent = 'üì°';
      } else if (useRealGPS && !gpsEnabled) {
        indicator.className = 'w-3 h-3 rounded-full bg-red-400';
        statusEl.textContent = 'GPS ERROR';
        toggle.className = 'p-2 rounded-lg transition-all active:scale-95 bg-red-600 text-white';
        toggle.textContent = 'üì°';
      } else {
        indicator.className = 'w-3 h-3 rounded-full bg-green-400 animate-pulse';
        statusEl.textContent = 'GPS SIM ON';
        toggle.className = 'p-2 rounded-lg transition-all active:scale-95 bg-gray-700 text-gray-400 hover:bg-gray-600';
        toggle.textContent = 'üéØ';
      }

      updateInstructions();
    }

    function updateInstructions() {
      const gpsText = useRealGPS ? 'GPS REAL' : 'GPS SIMULADO';
      const voiceText = speechEnabled ? 'üîä Voz ON' : 'üîá Voz OFF';
      document.getElementById('instructions').textContent = `üì± ${gpsText} | ‚¨ÜÔ∏è Carga .umap | ${voiceText}`;
    }

    // --- Controles mapa ---
    function zoomIn() { if (map) map.zoomIn(); }
    function zoomOut() { if (map) map.zoomOut(); }

    function centerOnTaxi() {
      if (map) {
        map.setView([taxiLocation.lat, taxiLocation.lng], 16);
        if (speechEnabled) speak('Centrado en taxi', { volume: 0.6 });
      }
    }

    // --- MI UBICACI√ìN (se llama con event para poder manipular el bot√≥n) ---
    function centerOnMyLocation(event) {
      if (!navigator.geolocation) {
        alert('GPS no disponible');
        return;
      }

      const btn = event?.currentTarget || null;
      if (btn) {
        btn.style.background = '#1E40AF';
        btn.innerHTML = '‚è≥';
      }

      navigator.geolocation.getCurrentPosition((position) => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;

        // centrar
        if (map) map.setView([lat, lng], 16);

        // marcador pulsante
        if (myLocationMarker) {
          try { map.removeLayer(myLocationMarker); } catch(e){}
        }
        const myLocationIcon = L.divIcon({
          className: 'my-location-marker',
          html: '<div class="my-location-pulse" style="width:20px; height:20px; background:#3B82F6; border:3px solid white; border-radius:50%; box-shadow:0 0 15px rgba(59,130,246,0.6);"></div>',
          iconSize: [20,20],
          iconAnchor: [10,10]
        });
        myLocationMarker = L.marker([lat, lng], { icon: myLocationIcon }).addTo(map);

        // anuncio por voz
        if (speechEnabled) speak('Ubicaci√≥n encontrada', { volume: 0.9 });

        // vibraci√≥n breve
        if (navigator.vibrate) navigator.vibrate(120);

        // geocodificaci√≥n inversa inmediata para la UI
        getStreetName(lat, lng);

        // quitar marcador tras 8 segundos
        setTimeout(() => {
          try { if (myLocationMarker) map.removeLayer(myLocationMarker); myLocationMarker = null; } catch(e){}
        }, 8000);

        // restaurar estilo del bot√≥n
        setTimeout(() => {
          if (btn) {
            btn.style.background = '';
            btn.innerHTML = 'üìç';
          }
        }, 900);
      }, (err) => {
        console.error('Error obteniendo ubicaci√≥n:', err);
        alert('No se pudo obtener la ubicaci√≥n');
        if (btn) { btn.style.background = ''; btn.innerHTML = 'üìç'; }
      }, { enableHighAccuracy:true, timeout:10000, maximumAge:2000 });
    }

    // --- Cargar archivo UMap / GeoJSON simple ---
    function loadUMapFile() {
      document.getElementById('fileInput').click();
    }

    function handleFileLoad(ev) {
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const obj = JSON.parse(text);
          // limpiar zonas previas
          clearZones();
          parseAndDrawZones(obj);
        } catch(err) {
          console.error('Error leyendo archivo', err);
          alert('Archivo inv√°lido. Aseg√∫rate de subir un .umap o .json v√°lido');
        } finally {
          // reset input
          ev.target.value = '';
        }
      };
      reader.readAsText(file);
    }

    function clearZones() {
      zoneShapes.forEach(s => { try { map.removeLayer(s); } catch(e){} });
      zoneShapes = [];
      zones = {};
      document.getElementById('zone-count').textContent = '0';
      document.getElementById('current-zone').textContent = 'Zona: Fuera de zona';
      zoneStartTime = null;
    }

    function parseAndDrawZones(geojsonLike) {
      // Soportamos varias estructuras: GeoJSON FeatureCollection o UMap export (que contiene "features")
      let features = [];
      if (geojsonLike.type === 'FeatureCollection' && Array.isArray(geojsonLike.features)) features = geojsonLike.features;
      else if (Array.isArray(geojsonLike.features)) features = geojsonLike.features;
      else if (Array.isArray(geojsonLike)) features = geojsonLike;
      else {
        // intentar buscar features en propiedades
        features = geojsonLike.features || [];
      }

      let count = 0;
      features.forEach((f, idx) => {
        try {
          const geom = f.geometry || f;
          const props = f.properties || {};
          if (!geom) return;

          if (geom.type === 'Polygon' || geom.type === 'MultiPolygon') {
            // convertir coordenadas [lng,lat] -> [lat,lng]
            const polyCoords = (geom.type === 'Polygon' ? geom.coordinates[0] : geom.coordinates[0][0])
              .map(coord => [coord[1], coord[0]]);
            const name = props.name || props.title || props.descr || `Zona ${idx+1}`;
            const color = zoneColors[count % zoneColors.length];

            const poly = L.polygon(polyCoords, { color, weight: 2, fillOpacity: 0.12 }).addTo(map);
            zoneShapes.push(poly);
            zones[name] = { type:'polygon', coordinates: polyCoords };
            count++;
          } else if (geom.type === 'Point') {
            // si tiene radius en properties -> c√≠rculo
            const coord = geom.coordinates;
            const lat = coord[1], lng = coord[0];
            const radius = props.radius || props.RADIUS || props.r || null;
            if (radius) {
              const name = props.name || props.title || props.descr || `Zona ${idx+1}`;
              const color = zoneColors[count % zoneColors.length];
              const circle = L.circle([lat, lng], { radius: Number(radius), color, weight: 2, fillOpacity: 0.08 }).addTo(map);
              zoneShapes.push(circle);
              zones[name] = { type:'circle', lat, lng, radius: Number(radius) };
              count++;
            } else {
              // Punto suelto -> marcador (se ignora como zona)
            }
          }
        } catch(e) {
          console.warn('Error procesando feature', e);
        }
      });

      document.getElementById('zone-count').textContent = `${count}`;
      if (count > 0) {
        speak(`Cargadas ${count} zonas`, { volume: 0.8 });
        // ajustar vista a todas las zonas
        try {
          const group = L.featureGroup(zoneShapes);
          map.fitBounds(group.getBounds(), { padding: [40,40] });
        } catch(e){}
      } else {
        alert('No se han detectado pol√≠gonos ni c√≠rculos con radio en el archivo.');
      }
    }

    // --- Inicializar en carga DOM ---
    window.addEventListener('DOMContentLoaded', () => {
      initMap();
      updateGPSStatus();
      updateInstructions();
    });

    // --- Evita errores al cerrar pesta√±a con speech activo ---
    window.addEventListener('beforeunload', () => {
      try { speechSynthesis.cancel(); } catch(e){}
      if (watchId) try { navigator.geolocation.clearWatch(watchId); } catch(e){}
    });
  </script>
</body>
</html>
